WITH APcte1 AS (SELECT 'Moseley AP Aging' AS "Company", amflib1.OPNPAY01.COMNO,amflib1.VENNAM.VNAME, amflib1.OPNPAY01.VNDNR,amflib1.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflib1.VENNAM.VNAMA
FROM amflib1.OPNPAY01
JOIN amflib1.VENNAM ON amflib1.OPNPAY01.vndnr=amflib1.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101),
APcte4 AS (SELECT 'Axxcss AP Aging' AS "Company", amflib4.OPNPAY01.COMNO,amflib4.VENNAM.VNAME, amflib4.OPNPAY01.VNDNR,amflib4.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflib4.VENNAM.VNAMA
FROM amflib4.OPNPAY01
JOIN amflib4.VENNAM ON amflib4.OPNPAY01.vndnr=amflib4.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101),
APcte5 AS (SELECT 'CarrierComm AP Aging' AS "Company", amflib5.OPNPAY01.COMNO,amflib5.VENNAM.VNAME, amflib5.OPNPAY01.VNDNR,amflib5.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflib5.VENNAM.VNAMA
FROM amflib5.OPNPAY01
JOIN amflib5.VENNAM ON amflib5.OPNPAY01.vndnr=amflib5.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101),
APcte10 AS (SELECT 'E-Band AP Aging' AS "Company", amfliba.OPNPAY01.COMNO,amfliba.VENNAM.VNAME, amfliba.OPNPAY01.VNDNR,amfliba.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amfliba.VENNAM.VNAMA
FROM amfliba.OPNPAY01
JOIN amfliba.VENNAM ON amfliba.OPNPAY01.vndnr=amfliba.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101),
APcte11 AS (SELECT 'REMEC AP Aging' AS "Company", amflibb.OPNPAY01.COMNO,amflibb.VENNAM.VNAME, amflibb.OPNPAY01.VNDNR,amflibb.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflibb.VENNAM.VNAMA
FROM amflibb.OPNPAY01
JOIN amflibb.VENNAM ON amflibb.OPNPAY01.vndnr=amflibb.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101),
BEGBALcte 
AS
(SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib1.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib4.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib5.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib6.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib7.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib8.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib9.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amfliba.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflibb.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0),
GLcte as
(SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB1.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib1.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB4.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib4.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB5.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib5.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIBa.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amfliba.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIBb.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflibb.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB6.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib6.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB8.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib8.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB9.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib9.CURHIS),
TOTALGLcte as
(SELECT 0 AS Period, COMNO, trim(GLANO) AS Account, BEGBAL AS Total
FROM BEGBALcte
UNION all
SELECT EMNTH AS Period, COMNO, trim(GLANO) AS Account, NormalizedAmount AS Total
FROM GLcte
-- Change year to last year to exclude it (current year is 120, 0 and 20 format depending on what company)
WHERE EYEAR <> 120 and EYEAR <> 119 and EYEAR <> 121 and EYEAR <> 21),
REPORTcte AS 
(SELECT "Company", sum(NormalizedAmount-PPATD) AS Total
FROM APcte1
GROUP BY "Company"
union
SELECT "Company", sum(NormalizedAmount-PPATD) AS Total
FROM APcte4
GROUP BY "Company"
UNION 
SELECT "Company", sum(NormalizedAmount-PPATD) AS Total
FROM APcte5
GROUP BY "Company"
UNION 
SELECT "Company", sum(NormalizedAmount-PPATD) AS Total
FROM APcte10
GROUP BY "Company"
UNION 
SELECT "Company", sum(NormalizedAmount-PPATD) AS Total
FROM APcte11
GROUP BY "Company"
UNION 
SELECT 'Axxcss GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 4 AND Account = 2201
UNION 
SELECT 'CarrierComm GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 5 AND Account = 2201
UNION 
SELECT 'E-Band GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 10 AND Account = 2201
UNION 
SELECT 'REMEC GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 11 AND Account = 2201
UNION 
SELECT 'Moseley GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 1 AND Account = 2201)
SELECT *
FROM REPORTcte
ORDER BY "Company"
